%% combine GCAMP data 20190702
file_suffix_list=[5,6,7,8,9,13,14,15,16,17,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,55,57,58,59,60,61,62,63,64,65,66];
file_prefix='';
max_value=16384;
file_position_list=[2152,512;...
    2154,512;...
    1916,412;...
    1916,409;...
    1600,335;...
    
    
    
    1155,258;...
    1154,259;...
    1154,257;...
    1160,257;...
    844,347;...
    
    1121,388;...
    1310,458;...
    1634,519;...
    1915,573;...
    1926,813;...
    1924,812;...
    1656,761;...
    1665,766;...
    1394,735;...
    1395,743;...
    1389,739;...
    1112,699;...
    827,701;...
    773,891;...
    748,843;...
    1022,933;...
    1025,931;...
    1020,921;...
    1310,962;...
    1300,963;...
    1579,1013;...
    1585,1009;...
    1858,1053;...
    1859,1054;...
    2138,1103;...
    1826,1409;...
    1827,1406;...
    1557,1366;...
    1548,1365;...
    1283,1318;...
    1001,1269;...
    729,1234;...
    724,1233;...
    636,1581;...
    669,1531;...
    
    898,1620;...
    
    897,1618;...
    1161,1663;...
    1160,1664;...
    1423,1705;...
    1421,1694;...
    1696,1745;...
    1446,1699;...
    1457,1701;...
    1703,1741;...
    1940,1792
    ];
% x_min=min(file_position_list(:,1));
% x_max=max(file_position_list(:,1));
% y_min=min(file_position_list(:,2));
% y_max=max(file_position_list(:,2));
position_offset=[636-257,257-257];
file_position_list=file_position_list-position_offset;
x_min=min(file_position_list(:,1));
x_max=max(file_position_list(:,1));
y_min=min(file_position_list(:,2));
y_max=max(file_position_list(:,2));
%%
raw_data=zeros(512,512,100,size(file_suffix_list,2));
N=1;
for file_id=file_suffix_list
    FileTif=[file_prefix,num2str(file_id,'%02d'),'.tif'];
    InfoImage=imfinfo(FileTif);
    mImage=InfoImage(1).Width;
    nImage=InfoImage(1).Height;
    NumberImages=length(InfoImage);
    m=zeros(nImage,mImage,NumberImages,'uint16');
    TifLink = Tiff(FileTif, 'r');
    for q=1:NumberImages
        TifLink.setDirectory(q);
        m(:,:,q)=TifLink.read();
    end
    TifLink.close();
    warning off;
    m=double(m);
    raw_data(:,:,:,N)=m;
    N=N+1;
end
%%
sigle_frame_data=zeros(y_max+255,x_max+255,size(file_suffix_list,2));
for time_frame=1:100
    for file_id=1:size(file_suffix_list,2)
        sigle_frame_data((file_position_list(file_id,2)-256):(file_position_list(file_id,2)+255),...
            (file_position_list(file_id,1)-256):(file_position_list(file_id,1)+255),...
            file_id)=raw_data(:,:,time_frame,file_id);
    end
    imwrite(max(sigle_frame_data,[],3)/max_value,['ALLFOV_time_',num2str(time_frame),'.tif']);
end